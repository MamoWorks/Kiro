name: Publish Release

on:
  push:
    branches:
      - 'main'
    paths:
      - '.version'
  workflow_dispatch:

jobs:
  # Job 1: åˆ›å»º Release
  create-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    outputs:
      project_name: ${{ steps.project_info.outputs.project_name }}
      version: ${{ steps.project_info.outputs.version }}
      tag_name: ${{ steps.project_info.outputs.tag_name }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get Project Info
        id: project_info
        run: |
          PROJECT_NAME=$(grep '^project_name=' .version | cut -d'=' -f2)
          VERSION=$(grep '^version=' .version | cut -d'=' -f2)
          TAG_NAME="v${VERSION}"

          echo "project_name=$PROJECT_NAME" >> $GITHUB_OUTPUT
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.project_info.outputs.tag_name }}
          name: ${{ steps.project_info.outputs.tag_name }}
          draft: false
          prerelease: false
          generate_release_notes: true

  # Job 2: å¹¶è¡Œæ„å»ºå¤šå¹³å°äºŒè¿›åˆ¶æ–‡ä»¶
  build:
    needs: create-release
    runs-on: ubuntu-latest
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - goos: windows
            goarch: amd64
            suffix: windows-x64.exe
          - goos: darwin
            goarch: amd64
            suffix: macos-amd64
          - goos: darwin
            goarch: arm64
            suffix: macos-arm64
          - goos: linux
            goarch: amd64
            suffix: linux-amd64
          - goos: linux
            goarch: arm64
            suffix: linux-arm64
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          cache: true

      - name: Build binary
        run: |
          OUTPUT="${{ needs.create-release.outputs.project_name }}-${{ needs.create-release.outputs.version }}-${{ matrix.suffix }}"
          CGO_ENABLED=0 GOOS=${{ matrix.goos }} GOARCH=${{ matrix.goarch }} \
            go build -ldflags="-s -w" -o ${OUTPUT} ./cmd/server
          echo "Built: ${OUTPUT}"

      - name: Upload Release Asset
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.create-release.outputs.tag_name }}
          files: ${{ needs.create-release.outputs.project_name }}-${{ needs.create-release.outputs.version }}-${{ matrix.suffix }}

  # Job 3: å‘å¸ƒæ‘˜è¦
  summary:
    needs: [create-release, build]
    runs-on: ubuntu-latest
    steps:
      - name: Release Summary
        run: |
          PROJECT_NAME="${{ needs.create-release.outputs.project_name }}"
          VERSION="${{ needs.create-release.outputs.version }}"
          TAG_NAME="${{ needs.create-release.outputs.tag_name }}"

          echo "## ğŸš€ Release Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Item | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| **Event Type** | \`${{ github.event_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Branch/Tag** | \`${{ github.ref_name }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Commit SHA** | \`${{ github.sha }}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Build Time** | \`$(date -u)\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package Name** | \`${PROJECT_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Package Version** | \`${VERSION}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Release Tag** | \`${TAG_NAME}\` |" >> $GITHUB_STEP_SUMMARY
          echo "| **Action** | âœ… **Built and Released** |" >> $GITHUB_STEP_SUMMARY
          echo "| **Platforms** | Windows (x64), macOS (Intel/ARM), Linux (AMD64/ARM64) |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“¦ Available Downloads:" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${PROJECT_NAME}-${VERSION}-windows-x64.exe" >> $GITHUB_STEP_SUMMARY
          echo "${PROJECT_NAME}-${VERSION}-macos-amd64" >> $GITHUB_STEP_SUMMARY
          echo "${PROJECT_NAME}-${VERSION}-macos-arm64" >> $GITHUB_STEP_SUMMARY
          echo "${PROJECT_NAME}-${VERSION}-linux-amd64" >> $GITHUB_STEP_SUMMARY
          echo "${PROJECT_NAME}-${VERSION}-linux-arm64" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ¯ Usage Examples:" >> $GITHUB_STEP_SUMMARY
          echo '```bash' >> $GITHUB_STEP_SUMMARY
          echo "# Windows (64-bit)" >> $GITHUB_STEP_SUMMARY
          echo "curl -L -o ${PROJECT_NAME}.exe https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${PROJECT_NAME}-${VERSION}-windows-x64.exe" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# macOS (ARM64)" >> $GITHUB_STEP_SUMMARY
          echo "curl -L -o ${PROJECT_NAME} https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${PROJECT_NAME}-${VERSION}-macos-arm64 && chmod +x ${PROJECT_NAME}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "# Linux (AMD64)" >> $GITHUB_STEP_SUMMARY
          echo "curl -L -o ${PROJECT_NAME} https://github.com/${{ github.repository }}/releases/download/${TAG_NAME}/${PROJECT_NAME}-${VERSION}-linux-amd64 && chmod +x ${PROJECT_NAME}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

      - name: Release success notification
        run: |
          echo "âœ… Multi-platform binary release completed successfully!"
          echo "ğŸ“Š Release Tag: ${{ needs.create-release.outputs.tag_name }}"
          echo "ğŸ—ï¸ Platforms: Windows (x64), macOS (Intel/ARM), Linux (AMD64/ARM64)"
